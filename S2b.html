<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Sổ doanh thu S2b-HKD</title>
    <style>
        /* Thiết lập khổ giấy A4 */
        @page { size: A4; margin: 1.5cm; }
        body { font-family: "Times New Roman", serif; padding: 0; color: black; line-height: 1.3; font-size: 13pt; }
        
        /* Cấu trúc bảng */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
        th, td { border: 1px solid black; padding: 6px; word-wrap: break-word; }
        th { background-color: #f2f2f2; }
        
        /* Định dạng text */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .bold { font-weight: bold; }
        .italic { font-style: italic; }
        
        /* Header & Title */
        .header-table { border: none !important; }
        .header-table td { border: none !important; padding: 0; }
        
        /* Footer ký tên */
        .footer-sign { margin-top: 30px; border: none !important; }
        .footer-sign td { border: none !important; text-align: center; vertical-align: top; width: 33%; padding-top: 10px; }

        /* Nút điều khiển */
        .no-print { 
            position: fixed; top: 10px; right: 10px; 
            background: #f8f9fa; padding: 10px; border: 1px solid #ddd; border-radius: 5px; 
        }
        button { cursor: pointer; padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 3px; font-weight: bold;}
        button:hover { background: #0056b3; }

        @media print { .no-print { display: none; } body { margin: 0; } }
    </style>
</head>
<body>

    <div class="no-print">
        <button onclick="window.print()">In báo cáo hoặc Lưu PDF</button>
        <p style="font-size: 11px; margin-top: 5px;">(Chọn "Lưu thành PDF" trong mục Máy in)</p>
    </div>

    <table class="header-table">
        <tr>
            <td style="width: 60%;">
                <div class="bold text-uppercase">HỘ KINH DOANH: <span id="out_ten"></span></div>
                <div class="bold">Mã số thuế: <span id="out_mst"></span></div>
                <div class="bold">Địa chỉ: <span id="out_dc"></span></div>
            </td>
            <td class="text-center" style="width: 40%;">
                <div class="bold">Mẫu số S2b-HKD</div>
                <div class="italic">(Ban hành kèm theo Thông tư số 88/2021/TT-BTC <br> ngày 11/10/2021 của Bộ Tài chính)</div>
            </td>
        </tr>
    </table>

    <div class="text-center" style="margin-top: 25px;">
        <h2 style="margin:0; text-transform: uppercase;">SỔ DOANH THU BÁN HÀNG HÓA, DỊCH VỤ</h2>
        <div class="bold" style="margin-top: 5px;">Kỳ kê khai: <span id="out_ky"></span></div>
        <div class="italic text-right" style="margin-top: 5px;">Đơn vị tính: VNĐ</div>
    </div>

    <table>
        <thead>
            <tr>
                <th colspan="2" style="width: 25%;">Chứng từ</th>
                <th rowspan="2" style="width: 50%;">Diễn giải</th>
                <th rowspan="2" style="width: 25%;">Số tiền</th>
            </tr>
            <tr>
                <th>Số hiệu (A)</th>
                <th>Ngày (B)</th>
            </tr>
        </thead>
        <tbody id="out_body">
            </tbody>
        <tfoot class="bold">
            <tr>
                <td colspan="3" class="text-center">TỔNG CỘNG DOANH THU</td>
                <td class="text-right" id="out_tong">0</td>
            </tr>
            <tr>
                <td colspan="3" class="text-center">Thuế GTGT phải nộp (<span id="out_rate">0</span>%)</td>
                <td class="text-right" id="out_vat">0</td>
            </tr>
        </tfoot>
    </table>

    <table class="footer-sign">
        <tr>
            <td colspan="2"></td>
            <td class="italic">Ngày ...... tháng ...... năm 20...</td>
        </tr>
        <tr class="bold">
            <td>Người lập biểu</td>
            <td>Kế toán trưởng</td>
            <td>Đại diện hộ kinh doanh</td>
        </tr>
        <tr>
            <td class="italic">(Ký, họ tên)</td>
            <td class="italic">(Ký, họ tên)</td>
            <td class="italic">(Ký, họ tên, đóng dấu)</td>
        </tr>
        <tr style="height: 80px;">
            <td></td>
            <td></td>
            <td></td>
        </tr>
    </table>

    <script>
        window.onload = function() {
            try {
                const data = JSON.parse(decodeURIComponent(window.location.hash.substring(1)));
                
                document.getElementById('out_ten').innerText = data.tenHKD;
                document.getElementById('out_mst').innerText = data.mst;
                document.getElementById('out_dc').innerText = data.diaChi;
                document.getElementById('out_ky').innerText = "Quý " + data.quy + " Năm " + data.nam;
                document.getElementById('out_rate').innerText = data.thueSuat;

                let html = ""; 
                let tong = 0;
                
                if(data.danhSachDong && data.danhSachDong.length > 0) {
                    data.danhSachDong.forEach(item => {
                        let st = parseFloat(item.st) || 0;
                        tong += st;
                        html += `<tr>
                            <td class="text-center">${item.sh}</td>
                            <td class="text-center">${item.ng}</td>
                            <td>${item.dg}</td>
                            <td class="text-right">${st.toLocaleString('vi-VN')}</td>
                        </tr>`;
                    });
                } else {
                    html = "<tr><td colspan='4' class='text-center italic'>Không có dữ liệu trong kỳ này</td></tr>";
                }

                document.getElementById('out_body').innerHTML = html;
                document.getElementById('out_tong').innerText = tong.toLocaleString('vi-VN');
                
                let thue = tong * (parseFloat(data.thueSuat) / 100);
                document.getElementById('out_vat').innerText = thue.toLocaleString('vi-VN');
                
            } catch (e) { 
                console.error("Lỗi parse dữ liệu:", e);
                alert("Không thể đọc dữ liệu báo cáo. Vui lòng kiểm tra lại công thức AppSheet.");
            }
        };
    </script>
</body>
</html>
