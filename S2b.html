<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Sổ doanh thu S2b-HKD</title>
    <style>
        /* Thiết lập khổ giấy A4 */
        @page { size: A4; margin: 1.5cm; }
        body { font-family: "Times New Roman", serif; padding: 0; color: black; line-height: 1.3; font-size: 12pt; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
        th, td { border: 1px solid black; padding: 6px; word-wrap: break-word; }
        th { background-color: #f2f2f2; }
        
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .bold { font-weight: bold; }
        .italic { font-style: italic; }
        
        /* Loại bỏ viền cho header và footer ký tên */
        .no-border-table, .no-border-table td { border: none !important; }

        /* Kỹ thuật để dòng tổng chỉ hiện ở trang cuối */
        .total-row { display: table-row; }
        
        @media print {
            .no-print { display: none; }
            /* Ép dòng tổng cộng không lặp lại ở mọi trang */
            tfoot { display: table-row-group; } 
        }

        .no-print { 
            position: fixed; top: 10px; right: 10px; 
            background: #fff; padding: 10px; border: 1px solid #007bff; border-radius: 5px; z-index: 9999;
        }
        button { cursor: pointer; padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 3px; font-weight: bold;}
    </style>
</head>
<body>

    <div class="no-print">
        <button onclick="window.print()">XUẤT PDF / IN BÁO CÁO</button>
    </div>

    <table class="no-border-table">
        <tr>
            <td style="width: 60%;">
                <div class="bold">HỘ KINH DOANH: <span id="out_ten"></span></div>
                <div class="bold">MST: <span id="out_mst"></span></div>
                <div class="bold">Địa chỉ: <span id="out_dc"></span></div>
            </td>
            <td class="text-right" style="width: 40%; font-size: 11pt;">
                <div class="bold">Mẫu số S2b-HKD</div>
                <div class="italic">(Thông tư số 152/2025/TT-BTC)</div>
            </td>
        </tr>
    </table>

    <div class="text-center" style="margin-top: 15px;">
        <h2 style="margin:0;">SỔ DOANH THU BÁN HÀNG HÓA, DỊCH VỤ</h2>
        <div class="bold">Kỳ kê khai: <span id="out_ky"></span></div>
    </div>

    <table>
        <thead>
            <tr>
                <th colspan="2" style="width: 25%;">Chứng từ</th>
                <th rowspan="2" style="width: 50%;">Diễn giải</th>
                <th rowspan="2" style="width: 25%;">Số tiền</th>
            </tr>
            <tr>
                <th>Số hiệu (A)</th>
                <th>Ngày (B)</th>
            </tr>
        </thead>
        <tbody id="out_body"></tbody>
        
        <tfoot>
            <tr class="bold">
                <td colspan="3" class="text-center">TỔNG CỘNG DOANH THU</td>
                <td class="text-right" id="out_tong">0</td>
            </tr>
            <tr class="bold">
                <td colspan="3" class="text-center">Thuế GTGT phải nộp (<span id="out_rate">0</span>%)</td>
                <td class="text-right" id="out_vat">0</td>
            </tr>
        </tfoot>
    </table>

    <table class="no-border-table" style="margin-top: 30px;">
        <tr>
            <td colspan="2"></td>
            <td class="italic text-center">Ngày ...... tháng ...... năm 20...</td>
        </tr>
        <tr class="bold text-center">
            <td>Người lập biểu</td>
            <td>Kế toán trưởng</td>
            <td>Đại diện hộ kinh doanh</td>
        </tr>
        <tr class="italic text-center">
            <td>(Ký, họ tên)</td>
            <td>(Ký, họ tên)</td>
            <td>(Ký, họ tên, đóng dấu)</td>
        </tr>
        <tr style="height: 80px;"><td></td><td></td><td></td></tr>
    </table>

    <script>
        window.onload = function() {
            try {
                const data = JSON.parse(decodeURIComponent(window.location.hash.substring(1)));
                document.getElementById('out_ten').innerText = data.tenHKD;
                document.getElementById('out_mst').innerText = data.mst;
                document.getElementById('out_dc').innerText = data.diaChi;
                document.getElementById('out_ky').innerText = "Quý " + data.quy + " Năm " + data.nam;
                document.getElementById('out_rate').innerText = data.thueSuat;

                let html = ""; let tong = 0;
                data.danhSachDong.forEach(item => {
                    let st = parseFloat(item.st) || 0;
                    tong += st;
                    html += `<tr>
                        <td class="text-center">${item.sh}</td>
                        <td class="text-center">${item.ng}</td>
                        <td>${item.dg}</td>
                        <td class="text-right">${st.toLocaleString('vi-VN')}</td>
                    </tr>`;
                });
                document.getElementById('out_body').innerHTML = html;
                document.getElementById('out_tong').innerText = tong.toLocaleString('vi-VN');
                let thue = tong * (parseFloat(data.thueSuat) / 100);
                document.getElementById('out_vat').innerText = thue.toLocaleString('vi-VN');
            } catch (e) { alert("Lỗi dữ liệu!"); }
        };
    </script>
</body>
</html>
