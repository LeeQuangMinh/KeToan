<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Sổ doanh thu S2b-HKD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @page { size: A4; margin: 0.8cm; }
        body { font-family: "Times New Roman", serif; color: black; line-height: 1.2; font-size: 11.5pt; margin: 0; padding: 0; }
        
        /* ĐIỀU CHỈNH TỶ LỆ CỘT MỚI */
        .col-sh { width: 23%; } /* Số hiệu: Vừa đủ cho mã dài */
        .col-ng { width: 13%; } /* Ngày: Giữ nguyên */
        .col-dg { width: 48%; } /* Diễn giải: Ưu tiên rộng nhất */
        .col-st { width: 16%; } /* Số tiền: Thu gọn tối đa để tránh mất chữ */

        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        
        /* Thu nhỏ padding để không gian chứa chữ rộng hơn */
        th, td { 
            border: 1px solid black; 
            padding: 4px 2px; /* Giảm khoảng cách viền 2 bên cực nhỏ */
            word-wrap: break-word; 
            overflow: hidden; 
        }
        
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .bold { font-weight: bold; }
        .italic { font-style: italic; }
        .no-border, .no-border td { border: none !important; }

        /* Giao diện nút bấm chuyên nghiệp */
        .no-print { 
            position: sticky; top: 0; background: #ffffff; padding: 10px; 
            border-bottom: 1px solid #ddd; display: flex; gap: 10px; justify-content: center; z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn { 
            cursor: pointer; padding: 10px 20px; border: none; border-radius: 5px; 
            font-weight: bold; color: white; font-size: 14px; text-transform: uppercase;
        }
        .btn-print { background: #555; }
        .btn-download { background: #d9534f; } /* Màu đỏ PDF */
        .btn-send { background: #5bc0de; }
        .btn:hover { opacity: 0.8; }

        @media print { 
            .no-print { display: none; }
            tfoot { display: table-row-group; } 
        }
    </style>
</head>
<body>

    <div class="no-print">
        <button class="btn btn-print" onclick="window.print()">In trực tiếp</button>
        <button class="btn btn-download" onclick="downloadPDF()">Tải PDF về máy</button>
        <button class="btn btn-send" onclick="sendEmail()">Gửi báo cáo</button>
    </div>

    <div id="content-to-export" style="padding: 10px;">
        <table class="no-border">
            <tr>
                <td style="width: 65%;">
                    <div class="bold">HỘ KINH DOANH: <span id="out_ten"></span></div>
                    <div class="bold">MST: <span id="out_mst"></span></div>
                    <div class="bold">Địa chỉ: <span id="out_dc"></span></div>
                </td>
                <td class="text-right" style="width: 35%; vertical-align: top;">
                    <div class="bold">Mẫu số S2b-HKD</div>
                    <div class="italic" style="font-size: 10pt;">(Thông tư số 152/2025/TT-BTC)</div>
                </td>
            </tr>
        </table>

        <div class="text-center" style="margin-top: 15px;">
            <h2 style="margin:0; font-size: 16pt;">SỔ DOANH THU BÁN HÀNG HÓA, DỊCH VỤ</h2>
            <div class="bold">Kỳ kê khai: <span id="out_ky"></span></div>
        </div>

        <table>
            <thead>
                <tr>
                    <th colspan="2">Chứng từ</th>
                    <th rowspan="2" class="col-dg">Diễn giải</th>
                    <th rowspan="2" class="col-st">Số tiền</th>
                </tr>
                <tr>
                    <th class="col-sh">Số hiệu (A)</th>
                    <th class="col-ng">Ngày (B)</th>
                </tr>
            </thead>
            <tbody id="out_body"></tbody>
            <tfoot>
                <tr class="bold">
                    <td colspan="3" class="text-center">TỔNG CỘNG DOANH THU</td>
                    <td class="text-right" id="out_tong">0</td>
                </tr>
                <tr class="bold">
                    <td colspan="3" class="text-center">Thuế GTGT phải nộp (<span id="out_rate">0</span>%)</td>
                    <td class="text-right" id="out_vat">0</td>
                </tr>
            </tfoot>
        </table>

        <table class="no-border" style="margin-top: 30px;">
            <tr><td colspan="2"></td><td class="italic text-center">Ngày ...... tháng ...... năm 20...</td></tr>
            <tr class="bold text-center" style="font-size: 11pt;">
                <td>Người lập biểu</td>
                <td>Kế toán trưởng</td>
                <td>Đại diện hộ kinh doanh</td>
            </tr>
            <tr style="height: 80px;"><td></td><td></td><td></td></tr>
        </table>
    </div>

    <script>
        // Xử lý dữ liệu từ AppSheet
        const hashData = window.location.hash.substring(1);
        if(hashData) {
            try {
                const data = JSON.parse(decodeURIComponent(hashData));
                document.getElementById('out_ten').innerText = data.tenHKD;
                document.getElementById('out_mst').innerText = data.mst;
                document.getElementById('out_dc').innerText = data.diaChi;
                document.getElementById('out_ky').innerText = `Quý ${data.quy} Năm ${data.nam}`;
                document.getElementById('out_rate').innerText = data.thueSuat;

                let html = ""; let tong = 0;
                data.danhSachDong.forEach(item => {
                    let st = parseFloat(item.st) || 0;
                    tong += st;
                    html += `<tr>
                        <td class="text-center">${item.sh}</td>
                        <td class="text-center">${item.ng}</td>
                        <td>${item.dg}</td>
                        <td class="text-right">${st.toLocaleString('vi-VN')}</td>
                    </tr>`;
                });
                document.getElementById('out_body').innerHTML = html;
                document.getElementById('out_tong').innerText = tong.toLocaleString('vi-VN');
                document.getElementById('out_vat').innerText = (tong * data.thueSuat / 100).toLocaleString('vi-VN');
            } catch (e) { console.error("Lỗi parse JSON"); }
        }

        // CHỨC NĂNG TẢI PDF TRỰC TIẾP
        function downloadPDF() {
            const element = document.getElementById('content-to-export');
            const opt = {
                margin: 5,
                filename: `So_Doanh_Thu_Q${data.quy}_${data.nam}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 3, useCORS: true }, // Tăng scale để chữ cực nét
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        // GỬI EMAIL (Mở trình duyệt mail)
        function sendEmail() {
            const subject = encodeURIComponent(`Báo cáo S2b Quý ${data.quy} - ${data.tenHKD}`);
            const body = encodeURIComponent("Kính gửi bộ phận kế toán,\nTôi gửi báo cáo doanh thu theo link đính kèm: " + window.location.href);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }
    </script>
</body>
</html>
