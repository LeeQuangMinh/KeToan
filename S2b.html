<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Sổ doanh thu S2b-HKD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @page { size: A4; margin: 1cm; }
        body { font-family: "Times New Roman", serif; color: black; line-height: 1.3; font-size: 12pt; margin: 0; padding: 0; }
        
        /* Chỉnh độ rộng cột theo yêu cầu */
        .col-sh { width: 22%; } /* Số hiệu: Dài hơn */
        .col-ng { width: 13%; } /* Ngày: Vừa đủ */
        .col-dg { width: 45%; } /* Diễn giải: Rộng nhất */
        .col-st { width: 20%; } /* Số tiền: Thu hẹp lại */

        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        th, td { border: 1px solid black; padding: 5px; word-wrap: break-word; overflow: hidden; }
        
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .bold { font-weight: bold; }
        .italic { font-style: italic; }
        .no-border, .no-border td { border: none !important; }

        /* Nút chức năng */
        .no-print { 
            position: sticky; top: 0; background: #f8f9fa; padding: 15px; 
            border-bottom: 2px solid #007bff; display: flex; gap: 10px; justify-content: center; z-index: 1000;
        }
        .btn { cursor: pointer; padding: 8px 16px; border: none; border-radius: 4px; font-weight: bold; color: white; transition: 0.3s; }
        .btn-print { background: #6c757d; }
        .btn-download { background: #28a745; }
        .btn-send { background: #ffc107; color: #212529; }
        .btn:hover { opacity: 0.8; }

        @media print { 
            .no-print { display: none; }
            tfoot { display: table-row-group; } /* Chỉ hiện trang cuối */
        }
    </style>
</head>
<body>

    <div class="no-print">
        <button class="btn btn-print" onclick="window.print()">IN BÁO CÁO</button>
        <button class="btn btn-download" onclick="downloadPDF()">TẢI FILE PDF</button>
        <button class="btn btn-send" onclick="sendEmail()">GỬI EMAIL</button>
    </div>

    <div id="content-to-export">
        <table class="no-border">
            <tr>
                <td style="width: 60%;">
                    <div class="bold">HỘ KINH DOANH: <span id="out_ten"></span></div>
                    <div class="bold">MST: <span id="out_mst"></span></div>
                    <div class="bold">Địa chỉ: <span id="out_dc"></span></div>
                </td>
                <td class="text-right" style="width: 40%;">
                    <div class="bold">Mẫu số S2b-HKD</div>
                    <div class="italic">(Thông tư số 152/2025/TT-BTC)</div>
                </td>
            </tr>
        </table>

        <div class="text-center" style="margin-top: 10px;">
            <h2 style="margin:0;">SỔ DOANH THU BÁN HÀNG HÓA, DỊCH VỤ</h2>
            <div class="bold">Kỳ kê khai: <span id="out_ky"></span></div>
        </div>

        <table>
            <thead>
                <tr>
                    <th colspan="2" style="width: 35%;">Chứng từ</th>
                    <th rowspan="2" class="col-dg">Diễn giải</th>
                    <th rowspan="2" class="col-st">Số tiền</th>
                </tr>
                <tr>
                    <th class="col-sh">Số hiệu (A)</th>
                    <th class="col-ng">Ngày (B)</th>
                </tr>
            </thead>
            <tbody id="out_body"></tbody>
            <tfoot>
                <tr class="bold">
                    <td colspan="3" class="text-center">TỔNG CỘNG DOANH THU</td>
                    <td class="text-right" id="out_tong">0</td>
                </tr>
                <tr class="bold">
                    <td colspan="3" class="text-center">Thuế GTGT phải nộp (<span id="out_rate">0</span>%)</td>
                    <td class="text-right" id="out_vat">0</td>
                </tr>
            </tfoot>
        </table>

        <table class="no-border" style="margin-top: 30px;">
            <tr><td colspan="2"></td><td class="italic text-center">Ngày ...... tháng ...... năm 20...</td></tr>
            <tr class="bold text-center">
                <td>Người lập biểu</td>
                <td>Kế toán trưởng</td>
                <td>Đại diện hộ kinh doanh</td>
            </tr>
            <tr style="height: 80px;"><td></td><td></td><td></td></tr>
        </table>
    </div>

    <script>
        // Lấy dữ liệu và hiển thị
        const hashData = window.location.hash.substring(1);
        const data = JSON.parse(decodeURIComponent(hashData));
        
        document.getElementById('out_ten').innerText = data.tenHKD;
        document.getElementById('out_mst').innerText = data.mst;
        document.getElementById('out_dc').innerText = data.diaChi;
        document.getElementById('out_ky').innerText = `Quý ${data.quy} Năm ${data.nam}`;
        document.getElementById('out_rate').innerText = data.thueSuat;

        let html = ""; let tong = 0;
        data.danhSachDong.forEach(item => {
            let st = parseFloat(item.st) || 0;
            tong += st;
            html += `<tr>
                <td class="text-center">${item.sh}</td>
                <td class="text-center">${item.ng}</td>
                <td>${item.dg}</td>
                <td class="text-right">${st.toLocaleString('vi-VN')}</td>
            </tr>`;
        });
        document.getElementById('out_body').innerHTML = html;
        document.getElementById('out_tong').innerText = tong.toLocaleString('vi-VN');
        document.getElementById('out_vat').innerText = (tong * data.thueSuat / 100).toLocaleString('vi-VN');

        // Hàm tải PDF trực tiếp
        function downloadPDF() {
            const element = document.getElementById('content-to-export');
            const opt = {
                margin: 10,
                filename: `So_Doanh_Thu_Q${data.quy}_${data.nam}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        // Hàm Gửi Email (Mở trình soạn thảo email)
        function sendEmail() {
            const subject = encodeURIComponent(`Báo cáo S2b Quý ${data.quy} - ${data.tenHKD}`);
            const body = encodeURIComponent(`Kính gửi,... \nTôi gửi báo cáo doanh thu Quý ${data.quy}. Vui lòng xem chi tiết tại link đính kèm.`);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }
    </script>
</body>
</html>
